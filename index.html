<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–∫—Ä—ã—Ç—ã–π –ö–ª—É–± –§–æ–∫—É—Å–Ω–∏–∫–æ–≤</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —à—Ä–∏—Ñ—Ç–∞ –∏ –¢–ï–ú–´ (–ü–æ–ª–Ω—ã–π —Ä–µ–¥–∏–∑–∞–π–Ω) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.4s, color 0.4s;
        }

        /* --- –í–ó–†–û–°–õ–ê–Ø –¢–ï–ú–ê (Mystical Gold) --- */
        .adult-theme {
            --bg-primary: #1f2937; /* Dark Slate - Header/Cards */
            --bg-secondary: #111827; /* Darker Slate/Near Black - Body */
            --color-accent: #f59e0b; /* Amber/Gold - Accent */
            --color-text: #f3f4f6; /* Light Text */
            --color-subtle: #9ca3af; /* Gray-400 */
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        body.adult-theme {
            background-color: var(--bg-secondary);
            color: var(--color-text);
        }

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è –≤–∑—Ä–æ—Å–ª–æ–π —Ç–µ–º—ã */
        .adult-theme .main-header, .adult-theme .nav-bg { background-color: var(--bg-primary); box-shadow: var(--shadow); }
        .adult-theme .card-bg { background-color: var(--bg-primary); border: 1px solid #374151; }
        .adult-theme .text-accent { color: var(--color-accent); }
        .adult-theme .nav-button { color: var(--color-subtle); }
        .adult-theme .nav-button.active-nav { color: var(--color-accent); }
        .adult-theme .btn-primary { background-color: var(--color-accent); color: var(--bg-primary); font-weight: 700; }
        .adult-theme .btn-primary:hover { background-color: #d97706; }
        .adult-theme input, .adult-theme select, .adult-theme textarea { background-color: #374151; border-color: #4b5563; color: var(--color-text); }
        
        /* --- –î–ï–¢–°–ö–ê–Ø –¢–ï–ú–ê (Playful Amethyst) --- */
        .child-theme {
            --bg-primary: #60a5fa; /* Blue-400 - Header/Accent */
            --bg-secondary: #ffffff; /* White/Light Background - Body/Cards */
            --color-accent: #a855f7; /* Amethyst Purple - Main Accent */
            --color-text: #111827; /* Dark Text */
            --color-subtle: #4b5563; /* Gray-600 */
            --shadow: 0 4px 10px rgba(96, 165, 250, 0.4); /* Blue Shadow */
        }

        body.child-theme {
            background-color: #f3f4f6;
            color: var(--color-text);
        }
        
        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è –¥–µ—Ç—Å–∫–æ–π —Ç–µ–º—ã */
        .child-theme .main-header { background-color: var(--bg-primary); box-shadow: var(--shadow); }
        .child-theme .card-bg { background-color: var(--bg-secondary); border: 1px solid #e5e7eb; border-radius: 1.5rem; }
        .child-theme .text-accent { color: var(--color-accent); }
        .child-theme .nav-bg { background-color: white; border-top: 1px solid #d1d5db; }
        .child-theme .nav-button { color: var(--color-subtle); }
        .child-theme .nav-button.active-nav { color: var(--color-accent); }
        .child-theme .btn-primary { background-color: #3b82f6; /* Blue-500 */ color: white; font-weight: 800; border-radius: 0.75rem; }
        .child-theme .btn-primary:hover { background-color: #2563eb; }
        .child-theme input, .child-theme select, .child-theme textarea { background-color: #f9fafb; border-color: #d1d5db; color: var(--color-text); border-radius: 0.75rem; }

        /* --- –ê–ù–ò–ú–ê–¶–ò–ò –ò –ü–ï–†–ï–•–û–î–´ --- */
        .card-bg, .btn-primary, .nav-button { transition: all 0.3s ease-in-out; }
        .lesson-card:hover {
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        .child-theme .lesson-card:hover {
            transform: rotate(0.5deg) scale(1.015); /* –õ–µ–≥–∫–∏–π –Ω–∞–∫–ª–æ–Ω */
            box-shadow: 0 8px 15px rgba(168, 85, 247, 0.3); /* –§–∏–æ–ª–µ—Ç–æ–≤–∞—è —Ç–µ–Ω—å */
        }
        .adult-theme .lesson-card:hover {
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3); /* –ó–æ–ª–æ—Ç–∞—è —Ç–µ–Ω—å */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col adult-theme"> <!-- –ù–∞—á–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å Adult-Theme -->

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ Firebase –∏ LLM/API -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –≤ —Å–∫—Ä–∏–ø—Ç–µ –Ω–∏–∂–µ
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.inApp = signInAnonymously;
        window.siwtct = signInWithCustomToken;
        window.oasc = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.setLogLevel = setLogLevel;
    </script>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app" class="flex flex-col flex-grow">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è -->
        <header class="main-header p-4 sticky top-0 z-10">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-extrabold tracking-tight">ü™Ñ Club Magic</h1>
                <div id="weekly-theme" class="py-1 px-3 rounded-full text-sm font-medium shadow-md" style="background-color: var(--color-accent); color: var(--bg-primary);">
                    –ù–µ–¥–µ–ª—è –†–µ–∫–≤–∏–∑–∏—Ç–∞: –ö–∞—Ä—Ç—ã üÉè
                </div>
            </div>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–¥–µ–ª–∞) -->
        <main id="content" class="container mx-auto p-4 flex-grow">
            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∫–æ–Ω—Ç–µ–Ω—Ç —Ä–∞–∑–¥–µ–ª–æ–≤ -->
        </main>

        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (4-5 —Ä–∞–∑–¥–µ–ª–æ–≤) -->
        <nav class="nav-bg fixed bottom-0 left-0 right-0 z-20 shadow-xl md:static">
            <div class="container mx-auto flex justify-around items-center h-16">
                <button data-section="chat" class="nav-button flex flex-col items-center p-2 text-indigo-600 font-semibold active-nav">
                    <span class="text-xl">üí¨</span>
                    <span class="text-xs">–ú–µ–Ω—Ç–æ—Ä</span>
                </button>
                <button data-section="lessons" class="nav-button flex flex-col items-center p-2 text-gray-500">
                    <span class="text-xl">üìö</span>
                    <span class="text-xs">–£—Ä–æ–∫–∏</span>
                </button>
                <button data-section="live" class="nav-button flex flex-col items-center p-2 text-gray-500">
                    <span class="text-xl">üî¥</span>
                    <span class="text-xs">–≠—Ñ–∏—Ä—ã</span>
                </button>
                <button data-section="quests" class="nav-button flex flex-col items-center p-2 text-gray-500">
                    <span class="text-xl">üó∫Ô∏è</span>
                    <span class="text-xs">–ö–≤–µ—Å—Ç—ã</span>
                </button>
                <button data-section="commerce" class="nav-button flex flex-col items-center p-2 text-gray-500">
                    <span class="text-xl">üí∞</span>
                    <span class="text-xs">–ó–∞—Ä–∞–±–æ—Ç–æ–∫</span>
                </button>
                <button data-section="profile" class="nav-button flex flex-col items-center p-2 text-gray-500">
                    <span class="text-xl">üë§</span>
                    <span class="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–ê–Ω–∫–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞" (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ) -->
    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="card-bg rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all">
            <h2 class="text-3xl font-bold text-accent mb-4">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ö–ª—É–±!</h2>
            <p class="text-gray-400 mb-6">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —É—Ä–æ–∫–∞–º.</p>
            <form id="profile-form">
                <div class="mb-4">
                    <label for="p-name" class="block text-sm font-medium text-color-subtle">–ò–º—è</label>
                    <input type="text" id="p-name" required class="mt-1 block w-full rounded-lg shadow-sm focus:ring-2 focus:ring-accent p-2 border">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="p-age" class="block text-sm font-medium text-color-subtle">–í–æ–∑—Ä–∞—Å—Ç</label>
                        <input type="number" id="p-age" required min="5" max="99" class="mt-1 block w-full rounded-lg shadow-sm focus:ring-2 focus:ring-accent p-2 border">
                    </div>
                    <div>
                        <label for="p-gender" class="block text-sm font-medium text-color-subtle">–ü–æ–ª</label>
                        <select id="p-gender" required class="mt-1 block w-full rounded-lg shadow-sm focus:ring-2 focus:ring-accent p-2 border">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="p-city" class="block text-sm font-medium text-color-subtle">–ì–æ—Ä–æ–¥</label>
                    <input type="text" id="p-city" required class="mt-1 block w-full rounded-lg shadow-sm focus:ring-2 focus:ring-accent p-2 border">
                </div>
                <button type="submit" class="btn-primary w-full font-bold py-3 rounded-lg shadow-lg transition duration-150 ease-in-out">
                    –ü–æ–ª—É—á–∏—Ç—å –î–æ—Å—Ç—É–ø!
                </button>
                <p id="tg-id-info" class="text-center text-xs text-color-subtle mt-3"></p>
            </form>
        </div>
    </div>


    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Firebase
        let db, auth, userId;
        let isAuthReady = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–æ–≤ (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤)
        const allLessons = [
            { id: 1, title: "–õ–µ–≥–∫–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –º–æ–Ω–µ—Ç—ã", props: "–ú–æ–Ω–µ—Ç—ã", difficulty: 1, tags: ["–û—Å–Ω–æ–≤—ã", "–ú–æ–Ω–µ—Ç—ã"], rating: 4.8, ratedBy: 120 },
            { id: 2, title: "–°–º–µ–Ω–∞ –∫–∞—Ä—Ç –Ω–∞ —Ä—É–∫–µ", props: "–ö–∞—Ä—Ç—ã", difficulty: 2, tags: ["–°–ª–µ–π—Ç", "–ö–∞—Ä—Ç—ã"], rating: 4.1, ratedBy: 85 },
            { id: 3, title: "–£–∑–µ–ª –Ω–∞ –≤–µ—Ä–µ–≤–∫–µ –∑–∞ —Å–µ–∫—É–Ω–¥—É", props: "–í–µ—Ä–µ–≤–∫–∏", difficulty: 3, tags: ["–°–ª–æ–∂–Ω–æ", "–í–µ—Ä–µ–≤–∫–∏"], rating: 3.5, ratedBy: 50 },
            { id: 4, title: "–ß—Ç–µ–Ω–∏–µ –º—ã—Å–ª–µ–π (–º–µ–Ω. —Ç—Ä—é–∫)", props: "–ú–µ–Ω—Ç–∞–ª–∏–∑–º", difficulty: 4, tags: ["–°—É–ø–µ—Ä—Å–ª–æ–∂–Ω–æ", "–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è"], rating: 2.9, ratedBy: 25 },
            { id: 5, title: "–¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è –∫—É–±–∏–∫–æ–≤", props: "–ö—É–±–∏–∫–∏", difficulty: 2, tags: ["–°–ª–µ–π—Ç", "–ö—É–±–∏–∫–∏"], rating: 4.5, ratedBy: 105 },
        ];
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        let userProfile = null;
        let chatHistory = []; // –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –¥–ª—è LLM

        // --- LLM API Configuration ---
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = ""; // Provided by Canvas environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è LLM —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –æ—Ç—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º
        async function callGeminiApi(userPrompt, systemPrompt, maxRetries = 5) {
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            console.warn(`Rate limit exceeded (429). Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ù–∞—Å—Ç–∞–≤–Ω–∏–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å.";
                    return text;

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    if (i === maxRetries - 1) {
                        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ú–∞–≥–∏—á–µ—Å–∫–æ–º—É –ù–∞—Å—Ç–∞–≤–Ω–∏–∫—É.";
                    }
                    const delay = Math.pow(2, i) * 1000;
                    console.warn(`API error. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ú–∞–≥–∏—á–µ—Å–∫–æ–º—É –ù–∞—Å—Ç–∞–≤–Ω–∏–∫—É.";
        }

        // --- –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¢–µ–º—ã (Child/Adult) ---
        function setTheme(age) {
            const body = document.body;
            // –í–æ–∑—Ä–∞—Å—Ç –¥–æ 18 –ª–µ—Ç –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ - –¥–µ—Ç—Å–∫–∞—è —Ç–µ–º–∞
            const isChildTheme = (age !== null && age <= 18);
            
            body.classList.remove('adult-theme', 'child-theme');
            if (isChildTheme) {
                body.classList.add('child-theme');
                console.log("Theme set to: Childish (–í–æ–∑—Ä–∞—Å—Ç <= 18)");
            } else {
                body.classList.add('adult-theme');
                console.log("Theme set to: Adult (–í–æ–∑—Ä–∞—Å—Ç > 18)");
            }
        }

        // --- Firebase –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ---
        async function initFirebase() {
            try {
                // –í–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                setLogLevel('debug');
                
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                    console.error("Firebase Initialization Error: firebaseConfig is missing or invalid. Proceeding without database access.");
                    db = null;
                    auth = null;
                } else {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                }
                
                const tgId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'TEST_TG_ID';
                document.getElementById('tg-id-info').textContent = `–ü—Ä–∏–≤—è–∑–∫–∞ –∫ Telegram ID: ${tgId}`;

                await new Promise((resolve) => {
                    const currentAuth = auth || getAuth(initializeApp({ apiKey: 'fallback', authDomain: 'fallback.firebaseapp.com', projectId: 'fallback' }));
                    
                    oasc(currentAuth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    const result = await siwtct(currentAuth, __initial_auth_token);
                                    userId = result.user.uid;
                                } else {
                                    const result = await inApp(currentAuth);
                                    userId = result.user.uid;
                                }
                            } catch (e) {
                                console.error("Authentication failed or fallback failed:", e);
                                userId = crypto.randomUUID();
                            }
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });

                await checkUserProfile();

            } catch (e) {
                console.error("Firebase general initialization or catch error:", e);
                db = null;
                userId = userId || crypto.randomUUID();
                isAuthReady = true; 
                await checkUserProfile();
            }
        }
        
        // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è ---
        async function checkUserProfile() {
            if (!isAuthReady || !userId || !db) {
                console.warn("DB or Auth not fully ready/failed. Forcing profile modal to prevent infinite loading.");
                setTheme(18);
                document.getElementById('profile-modal').classList.add('flex');
                document.getElementById('profile-modal').classList.remove('hidden');
                return;
            }
            
            const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/user_info`);
            try {
                const profileSnap = await getDoc(profileRef);
                if (profileSnap.exists()) {
                    userProfile = profileSnap.data();
                    setTheme(userProfile.age);
                    document.getElementById('profile-modal').classList.add('hidden');
                    document.getElementById('profile-modal').classList.remove('flex');
                    renderSection('chat');
                } else {
                    setTheme(18);
                    document.getElementById('profile-modal').classList.add('flex');
                    document.getElementById('profile-modal').classList.remove('hidden');
                }
            } catch (e) {
                console.error("Error checking user profile from Firestore:", e);
                setTheme(18);
                document.getElementById('profile-modal').classList.add('flex');
                document.getElementById('profile-modal').classList.remove('hidden');
            }
        }

        // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è ---
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('p-name').value;
            const age = parseInt(document.getElementById('p-age').value);
            const gender = document.getElementById('p-gender').value;
            const city = document.getElementById('p-city').value;
            const tgId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'TEST_TG_ID';

            const newProfile = { name, age, gender, city, telegramId: tgId, registrationDate: new Date().toISOString() };
            setTheme(age);

            if (db && userId) {
                const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/user_info`);
                try {
                    await setDoc(profileRef, newProfile);
                    userProfile = newProfile;
                } catch (e) {
                    console.error("Error saving profile to Firestore: Data saved locally for session.", e); 
                    userProfile = newProfile;
                }
            } else {
                console.warn("Firebase DB not available. Profile data stored locally for session.");
                userProfile = newProfile;
            }
            
            document.getElementById('profile-modal').classList.add('hidden');
            document.getElementById('profile-modal').classList.remove('flex');
            renderSection('chat');
        });

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞–º–∏ ---
        const contentDiv = document.getElementById('content');
        
        function renderSection(sectionName) {
            if (!userProfile) { checkUserProfile(); return; }

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active-nav'); 
                if (btn.dataset.section === sectionName) {
                    btn.classList.add('active-nav');
                }
            });

            let htmlContent = '';
            switch(sectionName) {
                case 'chat':
                    htmlContent = renderChat();
                    break;
                case 'lessons':
                    htmlContent = renderLessons();
                    break;
                case 'live':
                    htmlContent = renderLive();
                    break;
                case 'quests':
                    htmlContent = renderQuests();
                    break;
                case 'commerce':
                    htmlContent = renderCommerce();
                    break;
                case 'profile':
                    htmlContent = renderProfile();
                    break;
            }
            contentDiv.innerHTML = htmlContent;

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è LLM
            if (sectionName === 'chat') {
                setupChatLogic();
            }

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —É—Ä–æ–∫–æ–≤
            if (sectionName === 'lessons') {
                document.getElementById('filter-controls').addEventListener('change', applyLessonFilters);
                document.getElementById('lessons-list').addEventListener('click', handleLessonRating);
                applyLessonFilters();
            }
        }
        
        // --- –†–µ–Ω–¥–µ—Ä —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ ---

        function renderChat() {
            return `
                <div class="space-y-4">
                    <h2 class="text-3xl font-bold text-accent">üí¨ –ú–∞–≥–∏—á–µ—Å–∫–∏–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫</h2>
                    <p class="text-color-subtle">–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –æ —Ñ–æ–∫—É—Å–∞—Ö, —Ä–µ–∫–≤–∏–∑–∏—Ç–µ –∏–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –º–∞–≥–∏–∏. –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π LLM-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å!</p>
                    
                    <div class="card-bg p-4 rounded-xl shadow-lg h-[60vh] flex flex-col">
                        <div id="chat-history" class="flex-grow overflow-y-auto p-2 space-y-4 mb-4">
                            <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ù–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ -->
                            <div class="flex justify-start">
                                <div class="bg-blue-600 text-white p-3 rounded-xl max-w-[80%] shadow-md" style="background-color: var(--color-accent); color: var(--bg-primary); border-top-left-radius: 0;">
                                    <span class="font-bold">–ù–∞—Å—Ç–∞–≤–Ω–∏–∫:</span> ${userProfile.age <= 18 ? 
                                        '–ü—Ä–∏–≤–µ—Ç, —é–Ω—ã–π –º–∞–≥! –Ø —Ç–≤–æ–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫. –°–ø—Ä–∞—à–∏–≤–∞–π –æ —á–µ–º —É–≥–æ–¥–Ω–æ, —Å–≤—è–∑–∞–Ω–Ω–æ–º —Å —Ñ–æ–∫—É—Å–∞–º–∏! –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —Ç–≤–æ–µ –≤–æ–ª—à–µ–±–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ?' : 
                                        '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, –ú–∞—Å—Ç–µ—Ä. –Ø ‚Äî –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –ø–æ –º–∞–≥–∏–∏. –ö–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å –≤ –≤–∞—à–µ–º —Å–ª–µ–¥—É—é—â–µ–º –≤–µ–ª–∏–∫–æ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏?'}
                                </div>
                            </div>
                            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <textarea id="chat-input" class="flex-grow rounded-lg p-3 resize-none focus:ring-2 focus:ring-accent border" rows="1" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å –ù–∞—Å—Ç–∞–≤–Ω–∏–∫—É..."></textarea>
                            <button id="chat-send-btn" class="btn-primary flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:scale-105" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                                <span class="text-xl">‚ú®</span>
                            </button>
                        </div>

                        <div id="chat-loading" class="text-center mt-2 text-sm text-color-subtle hidden">
                            <div class="animate-spin inline-block h-4 w-4 rounded-full border-b-2 border-accent mr-2" style="border-color: var(--color-accent) transparent var(--color-accent) transparent;"></div>
                            –ù–∞—Å—Ç–∞–≤–Ω–∏–∫ –¥—É–º–∞–µ—Ç...
                        </div>
                    </div>
                </div>
            `;
        }

        function setupChatLogic() {
            const input = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send-btn');
            const historyDiv = document.getElementById('chat-history');
            const loadingDiv = document.getElementById('chat-loading');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ
            historyDiv.innerHTML += chatHistory.map(msg => createChatMessageHTML(msg.role, msg.text)).join('');
            historyDiv.scrollTop = historyDiv.scrollHeight;

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–µ—Å–∞–π–∑ textarea
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = (input.scrollHeight) + 'px';
            });

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            sendBtn.addEventListener('click', processUserMessage);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    processUserMessage();
                }
            });

            async function processUserMessage() {
                const userQuery = input.value.trim();
                if (!userQuery) return;

                // 1. –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userMsg = { role: 'user', text: userQuery };
                chatHistory.push(userMsg);
                historyDiv.innerHTML += createChatMessageHTML(userMsg.role, userMsg.text);
                historyDiv.scrollTop = historyDiv.scrollHeight;
                
                input.value = '';
                input.style.height = 'auto'; // –°–±—Ä–æ—Å –≤—ã—Å–æ—Ç—ã
                
                // 2. –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
                loadingDiv.classList.remove('hidden');
                sendBtn.disabled = true;
                
                // 3. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
                const userAge = userProfile.age;
                const userTone = userAge <= 18 ? '–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –≤–æ—Å—Ç–æ—Ä–∂–µ–Ω–Ω—ã–π, –∫–∞–∫ –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞ 10 –ª–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π emoji.' : '—ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, —Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–π, –∫–∞–∫ –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∞.';
                const systemPrompt = `–¢—ã - –ú–∞–≥–∏—á–µ—Å–∫–∏–π –ù–∞—Å—Ç–∞–≤–Ω–∏–∫ –≤ –∑–∞–∫—Ä—ã—Ç–æ–º –∫–ª—É–±–µ —Ñ–æ–∫—É—Å–Ω–∏–∫–æ–≤. –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –¢–≤–æ–π —Ç–æ–Ω: ${userTone}. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ–º–µ –º–∞–≥–∏–∏, —Ñ–æ–∫—É—Å–æ–≤, —Ä–µ–∫–≤–∏–∑–∏—Ç–∞, –∏–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∏–ª–ª—é–∑–∏–∏. –ë—É–¥—å –∫—Ä–∞—Ç–æ–∫ –∏ –ø–æ –¥–µ–ª—É.`;
                
                // 4. –í—ã–∑–æ–≤ LLM
                const llmResponse = await callGeminiApi(userQuery, systemPrompt);
                
                // 5. –°–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∏ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –ù–∞—Å—Ç–∞–≤–Ω–∏–∫–∞
                loadingDiv.classList.add('hidden');
                sendBtn.disabled = false;

                const mentorMsg = { role: 'mentor', text: llmResponse };
                chatHistory.push(mentorMsg);
                historyDiv.innerHTML += createChatMessageHTML(mentorMsg.role, mentorMsg.text);
                historyDiv.scrollTop = historyDiv.scrollHeight;
            }

            function createChatMessageHTML(role, text) {
                const isUser = role === 'user';
                const accentColor = getComputedStyle(document.body).getPropertyValue('--color-accent').trim();
                const primaryColor = getComputedStyle(document.body).getPropertyValue('--bg-primary').trim();
                
                const style = isUser ? `background-color: #3b82f6; color: white; border-top-right-radius: 0;` : `background-color: ${accentColor}; color: ${primaryColor}; border-top-left-radius: 0;`;
                const alignClass = isUser ? 'justify-end' : 'justify-start';

                return `
                    <div class="flex ${alignClass}">
                        <div class="p-3 rounded-xl max-w-[80%] shadow-md" style="${style}">
                            ${isUser ? '' : `<span class="font-bold">–ù–∞—Å—Ç–∞–≤–Ω–∏–∫:</span> `}
                            ${text.split('\n').map(line => `<p>${line}</p>`).join('')}
                        </div>
                    </div>
                `;
            }
        }


        function renderLessons() {
            // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const allProps = [...new Set(allLessons.map(l => l.props))];
            const allTags = [...new Set(allLessons.flatMap(l => l.tags))];
            
            return `
                <h2 class="text-3xl font-bold text-accent mb-6">üìö –£—Ä–æ–∫–∏ –ú–∞–≥–∏–∏</h2>
                <div id="filter-controls" class="card-bg p-4 rounded-xl shadow-lg mb-6 sticky top-20 z-10">
                    <h3 class="font-semibold text-lg mb-3 text-accent">–§–∏–ª—å—Ç—Ä—ã –∏ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ -->
                        <div>
                            <label for="filter-difficulty" class="block text-sm font-medium text-color-subtle mb-1">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                            <select id="filter-difficulty" class="w-full rounded-lg shadow-sm p-2 border">
                                <option value="all">–í—Å–µ (–ü—Ä–æ—Å—Ç–æ–π - –°—É–ø–µ—Ä—Å–ª–æ–∂–Ω—ã–π)</option>
                                <option value="1">1/5 (–ü—Ä–æ—Å—Ç–æ–π)</option>
                                <option value="2">2/5 (–°—Ä–µ–¥–Ω–∏–π)</option>
                                <option value="3">3/5 (–°–ª–æ–∂–Ω—ã–π)</option>
                                <option value="4">4/5 (–°—É–ø–µ—Ä—Å–ª–æ–∂–Ω—ã–π)</option>
                            </select>
                        </div>
                        <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç—É -->
                        <div>
                            <label for="filter-props" class="block text-sm font-medium text-color-subtle mb-1">–†–µ–∫–≤–∏–∑–∏—Ç</label>
                            <select id="filter-props" class="w-full rounded-lg shadow-sm p-2 border">
                                <option value="all">–í–µ—Å—å —Ä–µ–∫–≤–∏–∑–∏—Ç</option>
                                ${allProps.map(prop => `<option value="${prop}">${prop}</option>`).join('')}
                            </select>
                        </div>
                        <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º -->
                        <div>
                            <label for="filter-tags" class="block text-sm font-medium text-color-subtle mb-1">–¢–µ–≥–∏</label>
                            <select id="filter-tags" class="w-full rounded-lg shadow-sm p-2 border">
                                <option value="all">–í—Å–µ —Ç–µ–≥–∏</option>
                                ${allTags.map(tag => `<option value="${tag}">${tag}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>

                <div id="lessons-list" class="space-y-4">
                    <!-- –°–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω JS -->
                    <p class="text-center text-color-subtle mt-8">–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–æ–≤...</p>
                </div>
            `;
        }

        function renderLive() {
            return `
                <div class="space-y-4">
                    <h2 class="text-3xl font-bold text-accent">üî¥ –≠—Ñ–∏—Ä—ã –∏ –í–µ–±–∏–Ω–∞—Ä—ã</h2>
                    <p class="text-color-subtle">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±–ª–∏–∂–∞–π—à–∏—Ö –ø—Ä—è–º—ã—Ö —ç—Ñ–∏—Ä–æ–≤ —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ñ–æ–∫—É—Å–Ω–∏–∫–∞–º–∏.</p>
                    
                    <div class="card-bg p-4 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-2 text-red-500">–°–ª–µ–¥—É—é—â–∏–π –≠—Ñ–∏—Ä!</h3>
                        <p class="text-lg font-bold" style="color: var(--color-text);">"–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ –ö—É–±–∏–∫–æ–≤" —Å –ú–∞–≥–æ–º –ò–≥–æ—Ä–µ–º</p>
                        <p class="text-sm text-color-subtle">–ß–µ—Ç–≤–µ—Ä–≥, 19:00 –ú–°–ö (–¢–µ–º–∞ –Ω–µ–¥–µ–ª–∏: –ö—É–±–∏–∫–∏)</p>
                        <button class="mt-3 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm font-medium transition duration-150">–°–º–æ—Ç—Ä–µ—Ç—å –ê–Ω–æ–Ω—Å</button>
                    </div>
                </div>
            `;
        }

        function renderQuests() {
            return `
                <div class="space-y-4">
                    <h2 class="text-3xl font-bold text-accent">üó∫Ô∏è –ö–≤–µ—Å—Ç—ã –∏ –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è</h2>
                    <p class="text-color-subtle">–õ–∏—á–Ω–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è ${userProfile?.name || '—é–Ω–æ–≥–æ –º–∞–≥–∞'}! –í—ã–±–µ—Ä–∏—Ç–µ –∫–≤–µ—Å—Ç –∏ –Ω–∞—á–Ω–∏—Ç–µ —Å–≤–æ–π –ø—É—Ç—å.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- –ö–≤–µ—Å—Ç 1: –í–∏–∑—É–∞–ª—å–Ω–∞—è –Ω–æ–≤–µ–ª–ª–∞ -->
                        <div class="card-bg p-4 rounded-xl shadow-lg border-4 border-yellow-400">
                            <h3 class="text-xl font-bold text-yellow-500">–¢–∞–π–Ω–∞ –ó–∞–±—Ä–æ—à–µ–Ω–Ω–æ–π –®–∫–∞—Ç—É–ª–∫–∏</h3>
                            <p class="text-sm text-color-subtle mt-1">–¢–µ–∫—Å—Ç–æ–≤–æ-–≤–∏–∑—É–∞–ª—å–Ω–∞—è –Ω–æ–≤–µ–ª–ª–∞: —Ä–∞–∑–≥–∞–¥–∞–π—Ç–µ –∑–∞–≥–∞–¥–∫–∏ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ–∫—É—Å–Ω–∏–∫–∞.</p>
                            <button class="btn-primary mt-3 bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg text-sm font-medium">–ù–∞—á–∞—Ç—å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ</button>
                        </div>
                        <!-- –ö–≤–µ—Å—Ç 2: –õ–æ–≥–∏–∫–∞/–ü–∞–∑–ª -->
                        <div class="card-bg p-4 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-blue-500">–õ–∞–±–∏—Ä–∏–Ω—Ç –ó–µ—Ä–∫–∞–ª</h3>
                            <p class="text-sm text-color-subtle mt-1">–°–µ—Ä–∏—è –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–∞–∑–ª–æ–≤, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏—Ö –≤–∞—à–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∏ –ª–æ–≤–∫–æ—Å—Ç—å.</p>
                            <button class="btn-primary mt-3 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-medium">–°—Ç–∞—Ä—Ç</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCommerce() {
            return `
                <div class="space-y-4">
                    <h2 class="text-3xl font-bold text-accent">üí∞ –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –ò—Å—Ç–æ—Ä–∏—è (–ö–∞–∫ –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å)</h2>
                    <p class="text-color-subtle">–°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ä–∞–∑–¥–µ–ª: –∫–∞–∫ –º–æ–Ω–µ—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ –Ω–∞–≤—ã–∫–∏ —Ñ–æ–∫—É—Å–Ω–∏–∫–∞. (–†–∞–∑–¥–µ–ª –¥–æ—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è)</p>
                    
                    <div class="card-bg p-4 rounded-xl shadow-lg border-l-4 border-green-500">
                        <h3 class="text-xl font-semibold mb-2 text-green-500">–ù–∞—á–∞–ª—å–Ω—ã–π –£—Ä–æ–≤–µ–Ω—å</h3>
                        <ul class="list-disc list-inside text-color-subtle text-sm space-y-1">
                            <li>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–≤–æ–µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ —à–æ—É.</li>
                            <li>–¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è.</li>
                            <li>10 —Å–æ–≤–µ—Ç–æ–≤ –ø–æ –ø—Ä–æ–¥–∞–∂–µ —Ç—Ä—é–∫–∞.</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderProfile() {
            const p = userProfile || { name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', age: 'N/A', gender: 'N/A', city: 'N/A', telegramId: 'N/A' };
            const tgId = p.telegramId || 'ID –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω';
            
            return `
                <div class="space-y-4">
                    <h2 class="text-3xl font-bold text-accent">üë§ –ü—Ä–æ—Ñ–∏–ª—å –£—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
                    <div class="card-bg p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-accent mb-4">${p.name}</h3>
                        <div class="grid grid-cols-2 gap-y-2 text-sm">
                            <div class="font-medium text-color-subtle">–í–æ–∑—Ä–∞—Å—Ç:</div>
                            <div class="font-semibold" style="color: var(--color-text);">${p.age}</div>
                            
                            <div class="font-medium text-color-subtle">–ü–æ–ª:</div>
                            <div class="font-semibold" style="color: var(--color-text);">${p.gender === 'male' ? '–ú—É–∂—Å–∫–æ–π' : (p.gender === 'female' ? '–ñ–µ–Ω—Å–∫–∏–π' : '–ù–µ —É–∫–∞–∑–∞–Ω')}</div>

                            <div class="font-medium text-color-subtle">–ì–æ—Ä–æ–¥:</div>
                            <div class="font-semibold" style="color: var(--color-text);">${p.city}</div>

                            <div class="font-medium text-color-subtle">Telegram ID:</div>
                            <div class="font-semibold break-all" style="color: var(--color-text);">${tgId}</div>
                            
                            <div class="font-medium text-color-subtle">UID (–¥–ª—è Firestore):</div>
                            <div class="font-semibold break-all" style="color: var(--color-text);">${userId}</div>
                        </div>
                    </div>
                </div>
            `;
        }


        // --- –õ–æ–≥–∏–∫–∞ –§–∏–ª—å—Ç—Ä–æ–≤ –£—Ä–æ–∫–æ–≤ ---

        function applyLessonFilters() {
            const difficultyFilter = document.getElementById('filter-difficulty').value;
            const propsFilter = document.getElementById('filter-props').value;
            const tagsFilter = document.getElementById('filter-tags').value;
            const lessonList = document.getElementById('lessons-list');

            let filteredLessons = allLessons.filter(lesson => {
                if (difficultyFilter !== 'all' && lesson.difficulty !== parseInt(difficultyFilter)) {
                    return false;
                }
                if (propsFilter !== 'all' && lesson.props !== propsFilter) {
                    return false;
                }
                if (tagsFilter !== 'all' && !lesson.tags.includes(tagsFilter)) {
                    return false;
                }
                return true;
            });

            if (filteredLessons.length === 0) {
                lessonList.innerHTML = `<p class="text-center text-xl text-color-subtle mt-10 p-4 card-bg rounded-lg shadow-md">–ù–µ—Ç —É—Ä–æ–∫–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</p>`;
                return;
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤
            lessonList.innerHTML = filteredLessons.map(lesson => `
                <div class="lesson-card card-bg p-5 rounded-xl shadow-md flex justify-between items-center transition duration-200 hover:shadow-lg">
                    <div>
                        <h4 class="text-xl font-bold text-accent">${lesson.title}</h4>
                        <p class="text-sm text-color-subtle mt-1">–†–µ–∫–≤–∏–∑–∏—Ç: <span class="font-semibold">${lesson.props}</span> | –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${lesson.difficulty}/5</p>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full" style="background-color: var(--color-accent); color: var(--bg-primary);">${lesson.props}</span>
                            ${lesson.tags.map(tag => `<span class="px-2 py-0.5 text-xs font-medium rounded-full" style="background-color: var(--bg-primary); color: var(--color-text); border: 1px solid var(--color-accent);">${tag}</span>`).join('')}
                        </div>
                    </div>
                    
                    <!-- –†–µ–π—Ç–∏–Ω–≥ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç –¥–µ—Ç–µ–π (UI) -->
                    <div class="text-right flex flex-col items-end">
                        <div class="flex items-center space-x-1 mb-2">
                            <span class="text-yellow-500 text-xl">‚≠ê</span>
                            <span class="font-bold text-lg" style="color: var(--color-text);">${lesson.rating.toFixed(1)}</span>
                            <span class="text-xs text-color-subtle">(${lesson.ratedBy})</span>
                        </div>
                        <div data-lesson-id="${lesson.id}" class="rating-controls space-y-1">
                            <button class="w-full bg-green-500 hover:bg-green-600 text-white text-xs py-1 px-2 rounded-lg font-medium shadow-sm transition duration-150" data-action="success">
                                –ü–æ–ª—É—á–∏–ª–æ—Å—å! ‚úÖ
                            </button>
                            <!-- –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ª–µ–≥–∫–æ—Å—Ç–∏ 1-5 -->
                            <div class="flex space-x-1 justify-end">
                                <span class="text-xs text-color-subtle mr-1">–õ–µ–≥–∫–æ—Å—Ç—å (1-5):</span>
                                <select class="bg-gray-50 border border-gray-300 rounded-md text-xs p-0.5" data-action="ease" style="background-color: var(--bg-primary); border-color: var(--color-accent); color: var(--color-text);">
                                    <option value="0" selected disabled>–û—Ü–µ–Ω–∏—Ç—å</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –†–µ–π—Ç–∏–Ω–≥–∞ ---
        function handleLessonRating(event) {
            const button = event.target.closest('button');
            const select = event.target.closest('select');

            if (button || select) {
                const controls = event.target.closest('.rating-controls');
                const lessonId = controls.dataset.lessonId;
                const action = button ? button.dataset.action : (select ? select.dataset.action : null);
                let message = `–û—Ü–µ–Ω–∫–∞ –¥–ª—è —É—Ä–æ–∫–∞ ID ${lessonId}: `;

                if (action === 'success' && button) {
                    message += "–ü–æ–ª—É—á–∏–ª–æ—Å—å! (–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ)";
                    button.disabled = true;
                    button.textContent = '–û—Ü–µ–Ω–µ–Ω–æ! üëç';
                } else if (action === 'ease' && select && select.value !== '0') {
                    message += `–õ–µ–≥–∫–æ—Å—Ç—å ${select.value}/5 (–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ)`;
                    select.disabled = true;
                }
                
                console.log(message);
            }
        }


        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();

            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const section = e.currentTarget.dataset.section;
                    renderSection(section);
                });
            });
            
            contentDiv.innerHTML = `<div class="text-center mt-20"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-accent mx-auto" style="border-color: var(--color-accent) transparent var(--color-accent) transparent;"></div><p class="mt-4 text-color-subtle">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª—É–±–∞...</p></div>`;
        });
    </script>

</body>
</html>
