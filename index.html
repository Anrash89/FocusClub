<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–∫—Ä—ã—Ç—ã–π –ö–ª—É–± –§–æ–∫—É—Å–Ω–∏–∫–æ–≤</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —à—Ä–∏—Ñ—Ç–∞ –∏ –¢–ï–ú–´ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ --- */
        :root {
            /* Fallback/Default Colors (Adult Theme) */
            --bg-primary: #1e293b; /* Slate-800 */
            --bg-secondary: #0f172a; /* Slate-900 */
            --color-accent: #facc15; /* Amber-500 (–ó–æ–ª–æ—Ç–æ) */
            --color-text: #e2e8f0; /* Slate-200 */
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* --- –í–ó–†–û–°–õ–ê–Ø –¢–ï–ú–ê (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –∫–ª–∞—Å—Å adult-theme) --- */
        body, .adult-theme {
            background-color: var(--bg-secondary);
            color: var(--color-text);
        }

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è –≤–∑—Ä–æ—Å–ª–æ–π —Ç–µ–º—ã */
        .adult-theme .main-header { background-color: var(--bg-primary); box-shadow: var(--shadow); }
        .adult-theme .card-bg { background-color: var(--bg-primary); border: 1px solid #334155; }
        .adult-theme .text-accent { color: var(--color-accent); }
        .adult-theme .nav-bg { background-color: var(--bg-primary); border-top: 1px solid #334155; }
        .adult-theme .nav-button.active-nav { color: var(--color-accent); }
        .adult-theme .btn-primary { background-color: var(--color-accent); color: #1e293b; font-weight: 700; }
        .adult-theme .btn-primary:hover { background-color: #eab308; }
        .adult-theme input, .adult-theme select { background-color: #334155; border-color: #475569; color: var(--color-text); }
        
        /* --- –î–ï–¢–°–ö–ê–Ø –¢–ï–ú–ê (child-theme) --- */
        .child-theme {
            --bg-primary: #818cf8; /* Indigo-400 */
            --bg-secondary: #f7f7f7; /* Light Gray */
            --color-accent: #ef4444; /* Red-500 */
            --color-text: #1f2937; /* Gray-800 */
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .child-theme {
            background-color: var(--bg-secondary);
            color: var(--color-text);
        }
        
        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è –¥–µ—Ç—Å–∫–æ–π —Ç–µ–º—ã */
        .child-theme .main-header { background-color: var(--bg-primary); box-shadow: var(--shadow); }
        .child-theme .card-bg { background-color: white; border: 1px solid #e5e7eb; border-radius: 1.5rem; /* –ë–æ–ª–µ–µ –∫—Ä—É–≥–ª—ã–µ */ }
        .child-theme .text-accent { color: var(--color-accent); }
        .child-theme .nav-bg { background-color: white; border-top: 1px solid #e5e7eb; }
        .child-theme .nav-button.active-nav { color: var(--color-accent); }
        .child-theme .btn-primary { background-color: #3b82f6; /* Blue-500 */ color: white; font-weight: 800; }
        .child-theme .btn-primary:hover { background-color: #2563eb; }
        .child-theme input, .child-theme select { background-color: #f3f4f6; border-color: #d1d5db; color: var(--color-text); border-radius: 0.75rem; /* –ë–æ–ª–µ–µ –∫—Ä—É–≥–ª—ã–µ */ }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        .card-bg { transition: all 0.3s; }

        /* –¶–≤–µ—Ç–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–≤ Tailwind) */
        .nav-button { transition: color 0.15s; }
        .nav-button.active-nav { font-weight: 700; }
    </style>
</head>
<body class="min-h-screen flex flex-col adult-theme"> <!-- –ù–∞—á–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å Adult-Theme -->

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ Firebase –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –≤ —Å–∫—Ä–∏–ø—Ç–µ –Ω–∏–∂–µ
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.inApp = signInAnonymously;
        window.siwtct = signInWithCustomToken;
        window.oasc = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.setLogLevel = setLogLevel;
    </script>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app" class="flex flex-col flex-grow">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è -->
        <header class="main-header p-4 shadow-lg sticky top-0 z-10">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-extrabold tracking-tight">ü™Ñ Club Magic</h1>
                <div id="weekly-theme" class="py-1 px-3 rounded-full text-sm font-medium shadow-md" style="background-color: var(--color-accent); color: var(--bg-primary);">
                    –ù–µ–¥–µ–ª—è –†–µ–∫–≤–∏–∑–∏—Ç–∞: –ö–∞—Ä—Ç—ã üÉè
                </div>
            </div>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–¥–µ–ª–∞) -->
        <main id="content" class="container mx-auto p-4 flex-grow">
            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∫–æ–Ω—Ç–µ–Ω—Ç —Ä–∞–∑–¥–µ–ª–æ–≤ -->
        </main>

        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (4-5 —Ä–∞–∑–¥–µ–ª–æ–≤) -->
        <nav class="nav-bg fixed bottom-0 left-0 right-0 z-20 shadow-xl md:static">
            <div class="container mx-auto flex justify-around items-center h-16">
                <button data-section="chat" class="nav-button flex flex-col items-center p-2 text-indigo-600 font-semibold active-nav">
                    <span class="text-xl">üí¨</span>
                    <span class="text-xs">–ß–∞—Ç</span>
                </button>
                <button data-section="lessons" class="nav-button flex flex-col items-center p-2 text-gray-500">
                    <span class="text-xl">üìö</span>
                    <span class="text-xs">–£—Ä–æ–∫–∏</span>
                </button>
                <button data-section="live" class="nav-button flex flex-col items-center p-2 text-gray-500">
                    <span class="text-xl">üî¥</span>
                    <span class="text-xs">–≠—Ñ–∏—Ä—ã</span>
                </button>
                <button data-section="quests" class="nav-button flex flex-col items-center p-2 text-gray-500">
                    <span class="text-xl">üó∫Ô∏è</span>
                    <span class="text-xs">–ö–≤–µ—Å—Ç—ã</span>
                </button>
                <button data-section="commerce" class="nav-button flex flex-col items-center p-2 text-gray-500">
                    <span class="text-xl">üí∞</span>
                    <span class="text-xs">–ó–∞—Ä–∞–±–æ—Ç–æ–∫</span>
                </button>
                <button data-section="profile" class="nav-button flex flex-col items-center p-2 text-gray-500">
                    <span class="text-xl">üë§</span>
                    <span class="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–ê–Ω–∫–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞" (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ) -->
    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="card-bg rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all">
            <h2 class="text-3xl font-bold text-accent mb-4">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ö–ª—É–±!</h2>
            <p class="text-gray-400 mb-6">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —É—Ä–æ–∫–∞–º.</p>
            <form id="profile-form">
                <div class="mb-4">
                    <label for="p-name" class="block text-sm font-medium text-gray-400">–ò–º—è</label>
                    <input type="text" id="p-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="p-age" class="block text-sm font-medium text-gray-400">–í–æ–∑—Ä–∞—Å—Ç</label>
                        <input type="number" id="p-age" required min="5" max="99" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                    </div>
                    <div>
                        <label for="p-gender" class="block text-sm font-medium text-gray-400">–ü–æ–ª</label>
                        <select id="p-gender" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="p-city" class="block text-sm font-medium text-gray-400">–ì–æ—Ä–æ–¥</label>
                    <input type="text" id="p-city" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                </div>
                <button type="submit" class="btn-primary w-full font-bold py-3 rounded-lg shadow-lg transition duration-150 ease-in-out">
                    –ü–æ–ª—É—á–∏—Ç—å –î–æ—Å—Ç—É–ø!
                </button>
                <p id="tg-id-info" class="text-center text-xs text-gray-500 mt-3"></p>
            </form>
        </div>
    </div>


    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Firebase
        let db, auth, userId;
        let isAuthReady = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–æ–≤ (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤)
        const allLessons = [
            { id: 1, title: "–õ–µ–≥–∫–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –º–æ–Ω–µ—Ç—ã", props: "–ú–æ–Ω–µ—Ç—ã", difficulty: 1, tags: ["–û—Å–Ω–æ–≤—ã", "–ú–æ–Ω–µ—Ç—ã"], rating: 4.8, ratedBy: 120 },
            { id: 2, title: "–°–º–µ–Ω–∞ –∫–∞—Ä—Ç –Ω–∞ —Ä—É–∫–µ", props: "–ö–∞—Ä—Ç—ã", difficulty: 2, tags: ["–°–ª–µ–π—Ç", "–ö–∞—Ä—Ç—ã"], rating: 4.1, ratedBy: 85 },
            { id: 3, title: "–£–∑–µ–ª –Ω–∞ –≤–µ—Ä–µ–≤–∫–µ –∑–∞ —Å–µ–∫—É–Ω–¥—É", props: "–í–µ—Ä–µ–≤–∫–∏", difficulty: 3, tags: ["–°–ª–æ–∂–Ω–æ", "–í–µ—Ä–µ–≤–∫–∏"], rating: 3.5, ratedBy: 50 },
            { id: 4, title: "–ß—Ç–µ–Ω–∏–µ –º—ã—Å–ª–µ–π (–º–µ–Ω. —Ç—Ä—é–∫)", props: "–ú–µ–Ω—Ç–∞–ª–∏–∑–º", difficulty: 4, tags: ["–°—É–ø–µ—Ä—Å–ª–æ–∂–Ω–æ", "–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è"], rating: 2.9, ratedBy: 25 },
            { id: 5, title: "–¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è –∫—É–±–∏–∫–æ–≤", props: "–ö—É–±–∏–∫–∏", difficulty: 2, tags: ["–°–ª–µ–π—Ç", "–ö—É–±–∏–∫–∏"], rating: 4.5, ratedBy: 105 },
        ];
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        let userProfile = null;

        // --- –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¢–µ–º—ã (Child/Adult) ---
        function setTheme(age) {
            const body = document.body;
            // –í–æ–∑—Ä–∞—Å—Ç –¥–æ 18 –ª–µ—Ç –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ - –¥–µ—Ç—Å–∫–∞—è —Ç–µ–º–∞
            const isChildTheme = (age !== null && age <= 18);
            
            body.classList.remove('adult-theme', 'child-theme');
            if (isChildTheme) {
                body.classList.add('child-theme');
                console.log("Theme set to: Childish (–í–æ–∑—Ä–∞—Å—Ç <= 18)");
            } else {
                body.classList.add('adult-theme');
                console.log("Theme set to: Adult (–í–æ–∑—Ä–∞—Å—Ç > 18)");
            }
        }

        // --- Firebase –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ---
        async function initFirebase() {
            try {
                // –í–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                setLogLevel('debug');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–∞–ª–∏–¥–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò)
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                    console.error("Firebase Initialization Error: firebaseConfig is missing or invalid. Proceeding without database access.");
                    db = null; // –Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º db –≤ null
                    auth = null; // –Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º auth –≤ null
                } else {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                }
                

                // –ü–æ–ª—É—á–∞–µ–º ID Telegram, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
                const tgId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'TEST_TG_ID';
                document.getElementById('tg-id-info').textContent = `–ü—Ä–∏–≤—è–∑–∫–∞ –∫ Telegram ID: ${tgId}`;

                // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                await new Promise((resolve) => {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º auth, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–ª—è signInAnonymously
                    const currentAuth = auth || getAuth(initializeApp({ apiKey: 'fallback', authDomain: 'fallback.firebaseapp.com', projectId: 'fallback' }));
                    
                    oasc(currentAuth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase Authenticated. User ID:", userId);
                        } else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    const result = await siwtct(currentAuth, __initial_auth_token);
                                    userId = result.user.uid;
                                    console.log("Signed in with custom token. User ID:", userId);
                                } else {
                                    const result = await inApp(currentAuth);
                                    userId = result.user.uid;
                                    console.log("Signed in anonymously. User ID:", userId);
                                }
                                
                            } catch (e) {
                                console.error("Authentication failed or fallback failed:", e);
                                // –ü—Ä–∏ –æ—à–∏–±–∫–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID
                                userId = crypto.randomUUID();
                            }
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });

                // –ü–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                await checkUserProfile();

            } catch (e) {
                console.error("Firebase general initialization or catch error:", e);
                db = null; // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ DB —Å–±—Ä–æ—à–µ–Ω
                userId = userId || crypto.randomUUID(); // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã —Å–ª—É—á–∞–π–Ω—ã–π ID
                isAuthReady = true; 
                // –í —Å–ª—É—á–∞–µ –æ–±—â–µ–π –æ—à–∏–±–∫–∏, —Ç–∞–∫–∂–µ –≤—ã–∑—ã–≤–∞–µ–º checkUserProfile, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å UI
                await checkUserProfile();
            }
        }
        
        // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è ---
        async function checkUserProfile() {
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò: –ï—Å–ª–∏ –ë–î –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (db === null/undefined) –∏–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞,
            // –º—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –≤ Firestore. –ú—ã –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
            if (!isAuthReady || !userId || !db) {
                console.warn("DB or Auth not fully ready/failed. Forcing profile modal to prevent infinite loading.");
                setTheme(18); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∑—Ä–æ—Å–ª—É—é —Ç–µ–º—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
                document.getElementById('profile-modal').classList.add('flex');
                document.getElementById('profile-modal').classList.remove('hidden');
                return; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω–∏–ª –∞–Ω–∫–µ—Ç—É
            }
            
            const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/user_info`);
            try {
                const profileSnap = await getDoc(profileRef);
                if (profileSnap.exists()) {
                    userProfile = profileSnap.data();
                    console.log("User profile loaded:", userProfile);
                    
                    // !!! –£–°–¢–ê–ù–û–í–ö–ê –¢–ï–ú–´ –ü–û –í–û–ó–†–ê–°–¢–£ !!!
                    setTheme(userProfile.age);

                    // –ü—Ä–æ—Ñ–∏–ª—å –µ—Å—Ç—å, —Å–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                    document.getElementById('profile-modal').classList.add('hidden');
                    document.getElementById('profile-modal').classList.remove('flex');
                    renderSection('chat'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª
                } else {
                    console.log("User profile not found. Showing registration modal.");
                    setTheme(18); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∑—Ä–æ—Å–ª—É—é —Ç–µ–º—É, –ø–æ–∫–∞ –Ω–µ –±—É–¥–µ—Ç –≤–≤–µ–¥–µ–Ω –≤–æ–∑—Ä–∞—Å—Ç
                    // –ü—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    document.getElementById('profile-modal').classList.add('flex');
                    document.getElementById('profile-modal').classList.remove('hidden');
                }
            } catch (e) {
                console.error("Error checking user profile from Firestore:", e);
                setTheme(18); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∑—Ä–æ—Å–ª—É—é —Ç–µ–º—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
                // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ë–î, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
                document.getElementById('profile-modal').classList.add('flex');
                document.getElementById('profile-modal').classList.remove('hidden');
            }
        }

        // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è ---
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('p-name').value;
            const age = parseInt(document.getElementById('p-age').value); // –ü–æ–ª—É—á–∞–µ–º –∫–∞–∫ —á–∏—Å–ª–æ
            const gender = document.getElementById('p-gender').value;
            const city = document.getElementById('p-city').value;
            const tgId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'TEST_TG_ID';

            const newProfile = {
                name,
                age,
                gender,
                city,
                telegramId: tgId,
                registrationDate: new Date().toISOString()
            };

            // !!! –£–°–¢–ê–ù–û–í–ö–ê –¢–ï–ú–´ –ü–û –í–û–ó–†–ê–°–¢–£ !!!
            setTheme(age);

            // –ï—Å–ª–∏ DB –¥–æ—Å—Ç—É–ø–Ω–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore
            if (db && userId) {
                const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/user_info`);
                try {
                    await setDoc(profileRef, newProfile);
                    userProfile = newProfile;
                    console.log("Profile saved successfully to Firestore.");
                    // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                    document.getElementById('profile-modal').classList.add('hidden');
                    document.getElementById('profile-modal').classList.remove('flex');
                    renderSection('chat');
                } catch (e) {
                    console.error("Error saving profile to Firestore:", e);
                    // –í–º–µ—Å—Ç–æ alert(), –≤—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –Ω–∞ –∫–æ–Ω—Å–æ–ª—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º UI-—Å–æ–æ–±—â–µ–Ω–∏–µ
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º console.error –≤–º–µ—Å—Ç–æ alert, —á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                    console.error("Error saving profile to Firestore: Data saved locally for session."); 
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º, –∏—Å–ø–æ–ª—å–∑—É—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    userProfile = newProfile;
                    document.getElementById('profile-modal').classList.add('hidden');
                    document.getElementById('profile-modal').classList.remove('flex');
                    renderSection('chat');
                }
            } else {
                // –ï—Å–ª–∏ –ë–î –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (–æ—à–∏–±–∫–∞), –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                console.warn("Firebase DB not available. Profile data stored locally for session.");
                userProfile = newProfile;
                document.getElementById('profile-modal').classList.add('hidden');
                document.getElementById('profile-modal').classList.remove('flex');
                renderSection('chat');
            }
        });

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞–º–∏ ---
        const contentDiv = document.getElementById('content');
        
        function renderSection(sectionName) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø–æ–ª–Ω–µ–Ω –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å
            // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –≤—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∫–∞–∂–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ.
            if (!userProfile) {
                console.log("Profile missing, redirecting to modal check.");
                checkUserProfile();
                return;
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.querySelectorAll('.nav-button').forEach(btn => {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —Ü–≤–µ—Ç—É, —á—Ç–æ–±—ã –æ–Ω–∏ –∑–∞–≤–∏—Å–µ–ª–∏ –æ—Ç CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ–º—ã
                btn.classList.remove('text-indigo-600', 'text-gray-500', 'active-nav'); 
                if (btn.dataset.section === sectionName) {
                    btn.classList.add('active-nav');
                }
            });

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            let htmlContent = '';
            switch(sectionName) {
                case 'chat':
                    htmlContent = renderChat();
                    break;
                case 'lessons':
                    htmlContent = renderLessons();
                    break;
                case 'live':
                    htmlContent = renderLive();
                    break;
                case 'quests':
                    htmlContent = renderQuests();
                    break;
                case 'commerce':
                    htmlContent = renderCommerce();
                    break;
                case 'profile':
                    htmlContent = renderProfile();
                    break;
            }
            contentDiv.innerHTML = htmlContent;

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ "–£—Ä–æ–∫–∏" –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            if (sectionName === 'lessons') {
                document.getElementById('filter-controls').addEventListener('change', applyLessonFilters);
                document.getElementById('lessons-list').addEventListener('click', handleLessonRating);
                applyLessonFilters(); // –ò–∑–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —É—Ä–æ–∫–æ–≤
            }
        }
        
        // --- –†–µ–Ω–¥–µ—Ä —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ ---

        function renderChat() {
            return `
                <div class="space-y-4">
                    <h2 class="text-3xl font-bold text-accent">üí¨ –ß–∞—Ç –ö–ª—É–±–∞</h2>
                    <p class="text-gray-400">–û–±—â–∏–π —á–∞—Ç –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Ñ–æ–∫—É—Å–æ–≤, –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –∏–¥–µ–π. (–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞)</p>
                    
                    <div class="card-bg p-4 rounded-xl shadow-lg h-96 overflow-y-auto">
                        <!-- –ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π -->
                        <div class="text-sm mb-3">
                            <span class="font-semibold text-accent">–ú–∏—à–∞:</span> –í—Å–µ–º –ø—Ä–∏–≤–µ—Ç! –£ –∫–æ–≥–æ –µ—Å—Ç—å –∏–¥–µ–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ–∫—É—Å–∞ —Å –º–æ–Ω–µ—Ç–∞–º–∏?
                        </div>
                        <div class="text-sm mb-3 text-right">
                            <span class="font-semibold" style="color: var(--color-accent);">–Ø (–í—ã):</span> –Ø —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Å–≤–æ–∏–ª "–õ–µ–≥–∫–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ". –°—É–ø–µ—Ä —Ç—Ä—é–∫!
                        </div>
                        <!-- ... -->
                    </div>
                </div>
            `;
        }

        function renderLessons() {
            // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const allProps = [...new Set(allLessons.map(l => l.props))];
            const allTags = [...new Set(allLessons.flatMap(l => l.tags))];
            
            return `
                <h2 class="text-3xl font-bold text-accent mb-6">üìö –£—Ä–æ–∫–∏ –ú–∞–≥–∏–∏</h2>
                <div id="filter-controls" class="card-bg p-4 rounded-xl shadow-lg mb-6 sticky top-20 z-10">
                    <h3 class="font-semibold text-lg mb-3" style="color: var(--color-accent);">–§–∏–ª—å—Ç—Ä—ã –∏ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ -->
                        <div>
                            <label for="filter-difficulty" class="block text-sm font-medium text-gray-400 mb-1">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                            <select id="filter-difficulty" class="w-full rounded-lg shadow-sm p-2 border">
                                <option value="all">–í—Å–µ (–ü—Ä–æ—Å—Ç–æ–π - –°—É–ø–µ—Ä—Å–ª–æ–∂–Ω—ã–π)</option>
                                <option value="1">1/5 (–ü—Ä–æ—Å—Ç–æ–π)</option>
                                <option value="2">2/5 (–°—Ä–µ–¥–Ω–∏–π)</option>
                                <option value="3">3/5 (–°–ª–æ–∂–Ω—ã–π)</option>
                                <option value="4">4/5 (–°—É–ø–µ—Ä—Å–ª–æ–∂–Ω—ã–π)</option>
                            </select>
                        </div>
                        <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç—É -->
                        <div>
                            <label for="filter-props" class="block text-sm font-medium text-gray-400 mb-1">–†–µ–∫–≤–∏–∑–∏—Ç</label>
                            <select id="filter-props" class="w-full rounded-lg shadow-sm p-2 border">
                                <option value="all">–í–µ—Å—å —Ä–µ–∫–≤–∏–∑–∏—Ç</option>
                                ${allProps.map(prop => `<option value="${prop}">${prop}</option>`).join('')}
                            </select>
                        </div>
                        <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º -->
                        <div>
                            <label for="filter-tags" class="block text-sm font-medium text-gray-400 mb-1">–¢–µ–≥–∏</label>
                            <select id="filter-tags" class="w-full rounded-lg shadow-sm p-2 border">
                                <option value="all">–í—Å–µ —Ç–µ–≥–∏</option>
                                ${allTags.map(tag => `<option value="${tag}">${tag}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>

                <div id="lessons-list" class="space-y-4">
                    <!-- –°–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω JS -->
                    <p class="text-center text-gray-400 mt-8">–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–æ–≤...</p>
                </div>
            `;
        }

        function renderLive() {
            return `
                <div class="space-y-4">
                    <h2 class="text-3xl font-bold text-accent">üî¥ –≠—Ñ–∏—Ä—ã –∏ –í–µ–±–∏–Ω–∞—Ä—ã</h2>
                    <p class="text-gray-400">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±–ª–∏–∂–∞–π—à–∏—Ö –ø—Ä—è–º—ã—Ö —ç—Ñ–∏—Ä–æ–≤ —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ñ–æ–∫—É—Å–Ω–∏–∫–∞–º–∏.</p>
                    
                    <div class="card-bg p-4 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-2 text-red-500">–°–ª–µ–¥—É—é—â–∏–π –≠—Ñ–∏—Ä!</h3>
                        <p class="text-lg font-bold" style="color: var(--color-text);">"–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ –ö—É–±–∏–∫–æ–≤" —Å –ú–∞–≥–æ–º –ò–≥–æ—Ä–µ–º</p>
                        <p class="text-sm text-gray-500">–ß–µ—Ç–≤–µ—Ä–≥, 19:00 –ú–°–ö (–¢–µ–º–∞ –Ω–µ–¥–µ–ª–∏: –ö—É–±–∏–∫–∏)</p>
                        <button class="mt-3 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm font-medium">–°–º–æ—Ç—Ä–µ—Ç—å –ê–Ω–æ–Ω—Å</button>
                    </div>
                </div>
            `;
        }

        function renderQuests() {
            return `
                <div class="space-y-4">
                    <h2 class="text-3xl font-bold text-accent">üó∫Ô∏è –ö–≤–µ—Å—Ç—ã –∏ –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è</h2>
                    <p class="text-gray-400">–õ–∏—á–Ω–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è ${userProfile?.name || '—é–Ω–æ–≥–æ –º–∞–≥–∞'}! –í—ã–±–µ—Ä–∏—Ç–µ –∫–≤–µ—Å—Ç –∏ –Ω–∞—á–Ω–∏—Ç–µ —Å–≤–æ–π –ø—É—Ç—å.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- –ö–≤–µ—Å—Ç 1: –í–∏–∑—É–∞–ª—å–Ω–∞—è –Ω–æ–≤–µ–ª–ª–∞ -->
                        <div class="card-bg p-4 rounded-xl shadow-lg border-4 border-yellow-400">
                            <h3 class="text-xl font-bold text-yellow-500">–¢–∞–π–Ω–∞ –ó–∞–±—Ä–æ—à–µ–Ω–Ω–æ–π –®–∫–∞—Ç—É–ª–∫–∏</h3>
                            <p class="text-sm text-gray-400 mt-1">–¢–µ–∫—Å—Ç–æ–≤–æ-–≤–∏–∑—É–∞–ª—å–Ω–∞—è –Ω–æ–≤–µ–ª–ª–∞: —Ä–∞–∑–≥–∞–¥–∞–π—Ç–µ –∑–∞–≥–∞–¥–∫–∏ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ–∫—É—Å–Ω–∏–∫–∞.</p>
                            <button class="btn-primary mt-3 bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg text-sm font-medium" style="background-color: var(--color-accent); color: var(--bg-primary);">–ù–∞—á–∞—Ç—å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ</button>
                        </div>
                        <!-- –ö–≤–µ—Å—Ç 2: –õ–æ–≥–∏–∫–∞/–ü–∞–∑–ª -->
                        <div class="card-bg p-4 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-blue-500">–õ–∞–±–∏—Ä–∏–Ω—Ç –ó–µ—Ä–∫–∞–ª</h3>
                            <p class="text-sm text-gray-400 mt-1">–°–µ—Ä–∏—è –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–∞–∑–ª–æ–≤, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏—Ö –≤–∞—à–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∏ –ª–æ–≤–∫–æ—Å—Ç—å.</p>
                            <button class="btn-primary mt-3 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-medium">–°—Ç–∞—Ä—Ç</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCommerce() {
            return `
                <div class="space-y-4">
                    <h2 class="text-3xl font-bold text-accent">üí∞ –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –ò—Å—Ç–æ—Ä–∏—è (–ö–∞–∫ –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å)</h2>
                    <p class="text-gray-400">–°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ä–∞–∑–¥–µ–ª: –∫–∞–∫ –º–æ–Ω–µ—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ –Ω–∞–≤—ã–∫–∏ —Ñ–æ–∫—É—Å–Ω–∏–∫–∞. (–†–∞–∑–¥–µ–ª –¥–æ—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è)</p>
                    
                    <div class="card-bg p-4 rounded-xl shadow-lg border-l-4 border-green-500">
                        <h3 class="text-xl font-semibold mb-2 text-green-500">–ù–∞—á–∞–ª—å–Ω—ã–π –£—Ä–æ–≤–µ–Ω—å</h3>
                        <ul class="list-disc list-inside text-gray-400 text-sm space-y-1">
                            <li>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–≤–æ–µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ —à–æ—É.</li>
                            <li>–¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è.</li>
                            <li>10 —Å–æ–≤–µ—Ç–æ–≤ –ø–æ –ø—Ä–æ–¥–∞–∂–µ —Ç—Ä—é–∫–∞.</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderProfile() {
            const p = userProfile || { name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', age: 'N/A', gender: 'N/A', city: 'N/A', telegramId: 'N/A' };
            const tgId = p.telegramId || 'ID –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω';
            
            return `
                <div class="space-y-4">
                    <h2 class="text-3xl font-bold text-accent">üë§ –ü—Ä–æ—Ñ–∏–ª—å –£—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
                    <div class="card-bg p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-accent mb-4">${p.name}</h3>
                        <div class="grid grid-cols-2 gap-y-2 text-sm">
                            <div class="font-medium text-gray-500">–í–æ–∑—Ä–∞—Å—Ç:</div>
                            <div class="font-semibold" style="color: var(--color-text);">${p.age}</div>
                            
                            <div class="font-medium text-gray-500">–ü–æ–ª:</div>
                            <div class="font-semibold" style="color: var(--color-text);">${p.gender === 'male' ? '–ú—É–∂—Å–∫–æ–π' : (p.gender === 'female' ? '–ñ–µ–Ω—Å–∫–∏–π' : '–ù–µ —É–∫–∞–∑–∞–Ω')}</div>

                            <div class="font-medium text-gray-500">–ì–æ—Ä–æ–¥:</div>
                            <div class="font-semibold" style="color: var(--color-text);">${p.city}</div>

                            <div class="font-medium text-gray-500">Telegram ID:</div>
                            <div class="font-semibold break-all" style="color: var(--color-text);">${tgId}</div>
                            
                            <div class="font-medium text-gray-500">UID (–¥–ª—è Firestore):</div>
                            <div class="font-semibold break-all" style="color: var(--color-text);">${userId}</div>
                        </div>
                    </div>
                </div>
            `;
        }


        // --- –õ–æ–≥–∏–∫–∞ –§–∏–ª—å—Ç—Ä–æ–≤ –£—Ä–æ–∫–æ–≤ ---

        function applyLessonFilters() {
            const difficultyFilter = document.getElementById('filter-difficulty').value;
            const propsFilter = document.getElementById('filter-props').value;
            const tagsFilter = document.getElementById('filter-tags').value;
            const lessonList = document.getElementById('lessons-list');

            let filteredLessons = allLessons.filter(lesson => {
                // –§–∏–ª—å—Ç—Ä –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                if (difficultyFilter !== 'all' && lesson.difficulty !== parseInt(difficultyFilter)) {
                    return false;
                }
                // –§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç—É
                if (propsFilter !== 'all' && lesson.props !== propsFilter) {
                    return false;
                }
                // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º
                if (tagsFilter !== 'all' && !lesson.tags.includes(tagsFilter)) {
                    return false;
                }
                return true;
            });

            if (filteredLessons.length === 0) {
                lessonList.innerHTML = `<p class="text-center text-xl text-gray-500 mt-10 p-4 card-bg rounded-lg shadow-md">–ù–µ—Ç —É—Ä–æ–∫–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</p>`;
                return;
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤
            lessonList.innerHTML = filteredLessons.map(lesson => `
                <div class="lesson-card card-bg p-5 rounded-xl shadow-md flex justify-between items-center transition duration-200 hover:shadow-lg">
                    <div>
                        <h4 class="text-xl font-bold text-accent">${lesson.title}</h4>
                        <p class="text-sm text-gray-500 mt-1">–†–µ–∫–≤–∏–∑–∏—Ç: <span class="font-semibold">${lesson.props}</span> | –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${lesson.difficulty}/5</p>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full" style="background-color: var(--bg-secondary); color: var(--color-text);">${lesson.props}</span>
                            ${lesson.tags.map(tag => `<span class="px-2 py-0.5 text-xs font-medium rounded-full" style="background-color: #3b82f6; color: white;">${tag}</span>`).join('')}
                        </div>
                    </div>
                    
                    <!-- –†–µ–π—Ç–∏–Ω–≥ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç –¥–µ—Ç–µ–π (UI) -->
                    <div class="text-right flex flex-col items-end">
                        <div class="flex items-center space-x-1 mb-2">
                            <span class="text-yellow-500 text-xl">‚≠ê</span>
                            <span class="font-bold text-lg" style="color: var(--color-text);">${lesson.rating.toFixed(1)}</span>
                            <span class="text-xs text-gray-400">(${lesson.ratedBy})</span>
                        </div>
                        <div data-lesson-id="${lesson.id}" class="rating-controls space-y-1">
                            <button class="w-full bg-green-500 hover:bg-green-600 text-white text-xs py-1 px-2 rounded-lg font-medium shadow-sm" data-action="success">
                                –ü–æ–ª—É—á–∏–ª–æ—Å—å! ‚úÖ
                            </button>
                            <!-- –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ª–µ–≥–∫–æ—Å—Ç–∏ 1-5 -->
                            <div class="flex space-x-1 justify-end">
                                <span class="text-xs text-gray-500 mr-1">–õ–µ–≥–∫–æ—Å—Ç—å (1-5):</span>
                                <select class="bg-gray-50 border border-gray-300 rounded-md text-xs p-0.5" data-action="ease" style="background-color: var(--bg-secondary); border-color: var(--color-accent);">
                                    <option value="0" selected disabled>–û—Ü–µ–Ω–∏—Ç—å</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –†–µ–π—Ç–∏–Ω–≥–∞ ---
        function handleLessonRating(event) {
            const button = event.target.closest('button');
            const select = event.target.closest('select');

            if (button || select) {
                const controls = event.target.closest('.rating-controls');
                const lessonId = controls.dataset.lessonId;
                const action = button ? button.dataset.action : (select ? select.dataset.action : null);
                let message = `–û—Ü–µ–Ω–∫–∞ –¥–ª—è —É—Ä–æ–∫–∞ ID ${lessonId}: `;

                if (action === 'success' && button) {
                    // –°–∏–º—É–ª—è—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                    message += "–ü–æ–ª—É—á–∏–ª–æ—Å—å! (–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ)";
                    button.disabled = true;
                    button.textContent = '–û—Ü–µ–Ω–µ–Ω–æ! üëç';
                } else if (action === 'ease' && select && select.value !== '0') {
                    // –°–∏–º—É–ª—è—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                    message += `–õ–µ–≥–∫–æ—Å—Ç—å ${select.value}/5 (–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ)`;
                    select.disabled = true;
                }
                
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ setDoc –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –≤ Firestore
                console.log(message);
            }
        }


        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
        document.addEventListener('DOMContentLoaded', () => {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
            initFirebase();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const section = e.currentTarget.dataset.section;
                    renderSection(section);
                });
            });
            
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª (–±—É–¥–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è)
            contentDiv.innerHTML = `<div class="text-center mt-20"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500 mx-auto"></div><p class="mt-4 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª—É–±–∞...</p></div>`;
        });
    </script>

</body>
</html>
